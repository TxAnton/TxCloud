          Ассемблер для IBM PC. Глава 18.                            1


          ГЛАВА 18
          -----------------------------------------------------------
          
          Дисковая память IV: Функции BIOS
          
          Цель: Показать основные требования к программированию
          функций BIOS для создания и чтения дисковых файлов.
          
          ВВЕДЕНИЕ
          -----------------------------------------------------------
             Для  дисковых  операций  можно  программировать  непосред
          ственно  на  уровне  BIOS,   хотя  BIOS  и  не  обеспечивает
          автоматически  использование  оглавления  или  блокирование/
          деблокирование записей.  Дисковая операция BIOS INT 13H  рас
          сматривает  все  "записи",  как  имеющие  размер  сектора, а
          адресацию  диска  осуществляет   в  терминах  действительных
          номера дорожки и номера сектора.
             Для дисковых операций  чтения,  записи и верификации необ
          ходима инициализация следующих регистров:
             
          AH      Определяет тип операции: чтение, запись, верификация
                  или форматирование.
          AL      Определяет число секторов.
          CH      Определяет номер дорожки.
          CL      Определяет номер начального сектора.
          DH      Номер головки (стороны) : 0 или 1 для дискеты.
          DL      Номер дисковода: 0=A, 1=B и т.д.
          ES:BX   Адрес буфера ввода/вывода в области данных (за
                  исключением операции верификации).
          
          ДИСКОВЫЕ ОПЕРАЦИИ В BIOS
          -----------------------------------------------------------
             Для  указания  необходимой  дисковой  операции необходимо
          перед INT 13H загрузить в  регистр  AH  соответствующий код.
             
             AH = 00: Сброс системы контролера дисковода
             Данная операция осуществляет полный сброс контролера  дис
          ковода и требует для  выполнения INT 13H  загрузку в регистр
          AH  значение  шест.00.  Операция  используется  в   случаях,
          когда  после  других  дисковых  операций   возвращается  код
          серьезной  ошибки.
             
             AH = 01: Определить состояние дисковода
             Данная  операция  возвращает  в  регистре   AL  состояние
          дисковода после  последней  операции  вводда/вывода (см.Байт
          состояния  в  следующем  разделе).  Операция  требует только
          загрузки значения 01  в регистр AH.
             
             AH = 02: Чтение секторов
             Данная операция  выполняет чтение  в память определенного
          числа секторов на одной дорожке. Число секторов обычно 1,  8
          или 9.  Адрес памяти для области ввода  должен быть загружен
          в регистр BX,  причем следует  помнить,  что  реальный адрес

          
          Ассемблер для IBM PC. Глава 18.                            2


          зависит от содержимого регистра EX,  так как в данном случае
          используется регистровая  пара  ES:BX.  В  следующем примере
          выполняется чтение сектора в область  INSECT, которая должна
          быть достаточно большой, чтобы вместить все данные:
             
                    MOV  AH,02     ; Запрос на чтение
                    MOV  AL,01     ;  один сектор
                    LEA  BX,INSERT ; Буфер ввода в ES:BX
                    MOV  CH,05     ; Дорожка 05
                    MOV  CL,03     ; Сектор 03
                    MOV  DH,00     ; Сторона (головка) 00
                    MOV  DL,01     ; Дисковод 01 (B)
                    INT  13H       ; Вызов BIOS
             
             Число действительно прочитанных  секторов  возвращается в
          регистре  AL.  Регистры  DS,  BX,  CX  и  DX  сохраняют свои
          значения.
             В большинстве  случаев  программа  указывает  только один
          сектор  или все сектора  на  дорожке.  Для последовательного
          чтения  секторов  программа  должна  увеличивать  содержимое
          регистров  CH  и  CL.  Заметьте,  что  когда  номер  сектора
          достигает максимального значения,  его необходимо сбросить в
          01,  а номер дорожки увеличить на  1  или изменить сторону 0
          на  1  (для двухсторонних дискет).
             
             AH = 03: Запись секторов
             Данная  операция  записывает данные из  указанной области
          памяти  (обычно 512  байтов  или  кратное  512)  в  один или
          несколько  определенных   секторов.  Управляющая  информация
          загружается в регистры аналогично операции чтения диска (код
          02).   Операция  записи  возвращает  в  регистре   AL  число
          секторов,  которые действительно были записаны. Регистры DX,
          BX,  CX  и DX  сохраняют свои значения.
             
             AH = 04: Верификация сектора
             Данная операция проверяет, может ли быть найден указанный
          сектор,  и выполняет своего рода контроль на четность. Опера
          цию можно использовать  после записи  (код  03) для гарантии
          более  надежного вывода,  на что  потребуется дополнительное
          время ввода/вывода.  Значения регистров устанавливаются ана-
          логично операции  записи (код 03),  за исключением регистро-
          вой пары ES:BX  -  их инициализация не требуется.   Операция
          возвращает  в регистре  AL число  обработанных секторов. Ре-
          гистры DX,  BX, CX и DX сохраняют свои  значения.
             
             AH = 05: Форматирование дорожек
             Данная  операция используется для  форматирования  опреде
          ленного  числа дорожек в соответствии  с  одним  из  четырех
          размеров (стандарт для системы PC -  512). Операции чтения и
          записи   для   локализации    требуемого   сектора   требуют
          информацию о формате.  Для  форматирования  регистровая пара



          
          Ассемблер для IBM PC. Глава 18.                            3


          ES:BX должна  содержать адрес,  который указывает  на группу
          адресных полей для дорожки.  Для каждого сектора  на дорожке
          должен быть четырехбайтовый элемент в виде T/H/S|B, где
             
                   T номер дорожки,
                   H номер головки,
                   S номер сектора,
                   B число байт на секторе,
                     (00-128, 01-256, 02-512, 03-1024).
             
             Например,  для форматирования 03 дорожки, на стороне 00 и
          512  байтов на сектор,  первый элемент должен иметь значение
          шест.03000102  и  за  ним должны  быть  описаны элементы для
          остальных секторов на дорожке. Техническое руководство по AT
          содержит ряд дополнительных операций BIOS.
          
          БАЙТ СОСТОЯНИЯ
          ------------------------------------------------------------
             Для всех рассмотренных выше операций (02,  03, 04 и 05) в
          случае нормального завершения флаг CF и регистр  AH содержит
          0. В случае ошибки флаг CF устанавливается в 1, а регистр AH
          содержит  код  состояния,  идентифицирующий  причину ошибки.
          Код  состояния  аналогичен  значению  в  регистре  AL  после
          выполнения операции 01.
             
                    AH             Причина
               0000 0001      Ошибка команды для дискеты
               0000 0010      Не найден адресный маркер на диске
               0000 0011      Попытка записи на защищенный диск
               0000 0100      Не найден сектор
               0000 1000      Выход за границы DMA (памяти прямого
                              доступа)
               0000 1001      Попытка доступа через границу 64K
               0001 0000      Чтение сбойный участок на диске
               0010 0000      Ошибка контролера дисковода
               0100 0000      Ошибка установки (поиска)
               1000 0000      Ошибка оборудования
             
             В случае возникновения ошибки, обычным действием является
          сброс диска (AH=00)  и троекратное повторение операции. Если
          таким образом ошибка  не устраняется,  то на экран выводится
          соответствующее  сообщение  и  пользователь   может  сменить
          дискету.
          
          ПРОГРАММА: ИСПОЛЬЗОВАНИЕ BIOS ДЛЯ ЧТЕНИЯ СЕКТОРОВ
          ------------------------------------------------------------
             Рассмотрим программу,  приведенную на рис.18.1, в которой
          используется команда BIOS INT 13H для чтения секторов диска.
          Программа базируется на примере, приведенном на рис.16.3, со
          следующими   изменениями:
             
          1.   Отсутствует описание FCB и подпрограмма открытия.


          
          Ассемблер для IBM PC. Глава 18.                            4


          2.   Программа расчитывает каждый дисковый адрес.  После каж
               дого чтения  происходит увеличение номера  сектора. При
               достижении   номера   сектора   10   процедура  C10ADDR
               сбрасывает это значение в  01.  Если номер стороны = 1,
               программа  увеличивает  номер  дорожки;  затем меняется
               номер стороны: 0 на 1 и 1 на 0.
          3.   Область  CURADR  содержит  начальные  значения  номеров
               дорожки и сектора (их программа увеличивает), а область
               ENDADR -  конечные значения. Один из способов улучшения
               программы   -   предоставить  пользователю  возможность
               указать начальные и конечные номера дорожки и сектора с
               помощью соответствующего запроса.
             
             Выполните  данную  программу  под  управлением  отладчика
          DEBUG. Проделайте трассировку команд, которые инициализируют
          сегментные  регистры,  и  установите  начальный  и  конечный
          номера  секторов  для  файловой  таблицы  FAT  (расположение
          таблицы FAT различно в разных версиях операционной системы).
          Используя команду G (до)  для  выполнения  ввода  с  диска и
          проверки  считанного  содержимого  таблицы  FAT  и элементов
          оглавления.
          
          ------------------------------------------------------------
          ------------------------------------------------------------
            Рис.18.1. Использование BIOS для чтения дискового файла.
             
             В  качестве альтернативы,отладчику DEBUG  можно преобразо
          вать ASCII-символы в области ввода в их  шест. эквиваленты и
          выдать на экран эти значения,  как это делает отладчик DEBUG
          (см.  программу на рис.14.5).  Таким образом можно проверить
          содержимое любого  сектора (в  том  числе  "спрятанного"), а
          также предоставить  пользователю  возможность  внести измене
          ния и записать измененный сектор на диск.
             Следует помнить, что при создании файла DOS может вносить
          записи  на  любые доступные сектора,  которые не обязательно
          будут смежными  на  диске.  Следовательно, с помощью команды
          BIOS INT 13H нельзя выполнить последовательное чтение файла.
             
          ОСНОВНЫЕ ПОЛОЖЕНИЯ НА ПАМЯТЬ
          ------------------------------------------------------------
          -  Команда BIOS INT 13 обеспечивает прямой доступ к дорожкам
             и секторам диска.
          -  Команда BIOS  INT 13  не поддерживает операции  с оглавле
             нием,  обнаружение конца файла,  блокирование и деблокиро
             вание записей.
          -  Верификация  сектора   выполняет   элементарную  проверку
             записанных  данных,  что  приводит  к  увеличению времени
             обработки.
          -  Проверяйте байт состояния после каждой  дисковой операции
             через BIOS.
          
          ВОПРОСЫ ДЛЯ САМОПРОВЕРКИ
          ------------------------------------------------------------

          
          Ассемблер для IBM PC. Глава 18.                            5


          18.1.  Напишите команды для сброса дискового контролера.
          18.2.  Напишите команды для чтения байта состояния дискеты.
          18.3.  Напишите команды для BIOS INT 13H, выполняющие чтение
                 одного сектора  в область памяти  INDISK, с дисковода
                 A, головки 0, дорожки 6 и сектора 3.
          18.4.  Напишите команды для BIOS INT 13H, выполняющие запись
                 трех секторов из области памяти OUTDISK,  на дисковод
                 B, головку 0, дорожку 8 и сектор 1.
          18.5.  При  записи данных в вопросе 18.4,  как  можно распоз
                 нать попытку записи на защищенный диск?
          18.6.  На  основе  вопроса  18.4  напишите  команды контроля
                 записи (операция верификации).










































          
